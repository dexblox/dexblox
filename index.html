<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DEXBLOX.ID - Topup Robux</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(-45deg, #000000, #001f1f, #003333, #000000);
      background-size: 400% 400%;
      animation: gradientMove 15s ease infinite;
      font-family: monospace;
    }
    @keyframes gradientMove {
      0% {background-position: 0% 50%;}
      50% {background-position: 100% 50%;}
      100% {background-position: 0% 50%;}
    }
    .paket-card {transition:all 0.3s ease; cursor:pointer; background-color:#2d3748;}
    .paket-card:hover {transform:scale(1.03);}
    .glow-title {color:#00ffff; text-shadow:0 0 10px #00ffff,0 0 20px #00ffff;}
    .logo-glitch {filter:drop-shadow(0 0 10px #00ffff) drop-shadow(0 0 20px #00ffff); animation: glitch 1.2s infinite;}
    @keyframes glitch {
      0% {transform: translate(0);}
      20% {transform: translate(-1px, 1px);}
      40% {transform: translate(-1px, -1px);}
      60% {transform: translate(1px, 1px);}
      80% {transform: translate(1px, -1px);}
      100% {transform: translate(0);}
    }
    #receiptModal, #adminModal {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.7); display:none;
      align-items:center; justify-content:center; z-index:50;
    }
    #receiptContent {
      background:#1a202c; border:2px solid #00ffff;
      box-shadow:0 0 20px #00ffff,0 0 40px #00ffff;
      padding:20px; border-radius:12px; text-align:center; max-width:320px;
    }
    /* Tema putih besar khusus admin */
    #adminContent {
      background:#ffffff; color:#000000;
      padding:40px; border-radius:16px; text-align:center; max-width:480px;
      box-shadow:0 0 20px rgba(0,0,0,0.3);
    }
    .glow-price {text-shadow:0 0 10px #00ff00,0 0 20px #00ff00;}
    #avatarPreview {box-shadow:0 0 15px #00ffff,0 0 30px #00ffff;}
    #particleCanvas {position: fixed; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events:none;}
    .glow-footer {text-shadow:0 0 6px rgba(255,255,255,0.6),0 0 12px rgba(255,255,255,0.4);}
    /* Avatar full body tanpa frame */
    .admin-avatar img {
      width: 200px; height: auto;
      border: none; box-shadow: none;
      margin: 0 auto;
    }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen relative">

  <!-- Background Partikel -->
  <canvas id="particleCanvas"></canvas>

  <!-- Header -->
  <header class="z-10 text-center mt-6 mb-6">
    <img src="/dexblox.png" alt="Logo DEXBLOX" class="logo-glitch mx-auto mb-4 w-40 h-40">
    <h1 class="text-5xl font-extrabold glow-title">DEXBLOX.ID</h1>
    <p class="text-green-400 mt-2">Topup Robux Termurah & Transparan</p>
  </header>

  <!-- Form Topup -->
  <div class="z-10 w-[90%] max-w-md bg-gray-900 bg-opacity-70 p-6 rounded-xl shadow-lg text-center">
    <h2 class="text-2xl font-bold text-cyan-400 mb-4">Topup Gamepass 5hari</h2>
    <form id="topupForm" class="space-y-6">
      <div>
        <label class="block mb-1 text-white">Username Roblox</label>
        <input type="text" id="username" class="w-full p-2 rounded bg-gray-700 text-white text-center" placeholder="Masukkan Username Roblox">
        <p id="notifUsername" class="text-xs mt-1"></p>
        <div class="mt-4 text-center">
          <img id="avatarPreview" class="hidden mx-auto rounded-full border-2 border-cyan-400" width="120" height="120" alt="Avatar Roblox">
        </div>
        <button type="button" onclick="cekUsername()" class="bg-yellow-400 hover:bg-yellow-500 text-black font-bold px-4 py-2 rounded mt-2">Cek Username</button>
      </div>

      <section>
        <h3 class="text-lg font-bold text-cyan-400 mb-2">Harga Hari Ini</h3>
        <p class="text-white mb-4">
          Rp <span id="hargaHariIni" class="text-2xl font-extrabold text-green-400 glow-price">12.000</span> / 100 Robux
        </p>
        <div class="grid grid-cols-2 gap-4">
          <div onclick="togglePaket(this)" class="paket-card p-4 rounded-lg text-white font-bold" data-value="100">100 Robux</div>
          <div onclick="togglePaket(this)" class="paket-card p-4 rounded-lg text-white font-bold" data-value="200">200 Robux</div>
          <div onclick="togglePaket(this)" class="paket-card p-4 rounded-lg text-white font-bold" data-value="500">500 Robux</div>
          <div onclick="togglePaket(this)" class="paket-card p-4 rounded-lg text-white font-bold" data-value="1000">1000 Robux</div>
        </div>
        <p id="notifPaket" class="text-xs mt-1"></p>
      </section>

      <section>
        <h3 class="text-lg font-bold text-cyan-400 mb-2">Custom Paket Robux</h3>
        <input type="number" id="customRobux" class="p-2 rounded bg-gray-700 text-white text-center w-48" placeholder="Jumlah Robux">
        <p id="notifCustom" class="text-xs mt-1"></p>
      </section>

      <p id="paketInfo" class="text-green-400 font-bold mt-2"></p>
      <input type="hidden" id="robux" name="robux">

      <div>
        <label class="block mb-1 text-white">Kode Promo</label>
        <div class="flex space-x-2">
          <input type="text" id="promoInput" class="flex-1 p-2 rounded bg-gray-700 text-white text-center" placeholder="Masukkan kode promo">
          <button type="button" onclick="checkPromo()" class="bg-yellow-400 hover:bg-yellow-500 text-black font-bold px-4 rounded">Cek</button>
        </div>
        <p id="notifPromo" class="text-xs mt-1"></p>
      </div>

      <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded shadow-lg">Topup</button>
    </form>
  </div>

  <!-- Modal Receipt -->
  <div id="receiptModal">
    <div id="receiptContent">
      <h2 class="text-cyan-400 font-bold text-xl mb-4">Konfirmasi Pesanan</h2>
      <p id="rUsername" class="text-white mb-2"></p>
      <p id="rRobux" class="text-green-400 mb-2"></p>
      <p id="rHarga" class="text-white mb-2"></p>
      <p id="rPromo" class="text-yellow-400 mb-2"></p>
      <p id="rDate" class="text-white mb-2"></p>
      <p id="rEstimate" class="text-white mb-4"></p>
      <div class="avatar mt-4">
        <img id="rAvatar" src="" alt="Avatar Roblox" class="mx-auto rounded-full border-2 border-cyan-400 w-24 h-24">
      </div>
      <div class="flex justify-center space-x-4 mt-4">
        <button id="sendWA" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">Kirim WA</button>
        <button onclick="closeReceipt()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">Tutup</button>
      </div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="adminModal">
    <div id="adminContent">
      <h2 class="font-bold text-2xl mb-6">Admin Panel</h2>
      <input type="password" id="adminPassword" class="w-full p-3 rounded border border-gray-400 text-center mb-6" placeholder="Masukkan Password Admin">
      
      <!-- Avatar full body preview -->
      <div class="admin-avatar mb-6">
        <img id="adminAvatarFull" src="" alt="Avatar Roblox Full Body">
      </div>

      <div id="adminToolsHarga" class="hidden">
        <h3 class="font-bold mb-2">Update Harga</h3>
        <input type="number" id="baseHarga" class="w-full p-2 rounded border border-gray-400 text-center mb-4" placeholder="Masukkan harga baru">
        <button onclick="updateHarga()" class="bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-2 rounded">Simpan Harga</button>
      </div>

      <div id="adminToolsPesanan" class="hidden mt-6">
        <h3 class="font-bold mb-2">Konfirmasi Pesanan</h3>
        <button onclick="generateReceipt()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">Buat Receipt</button>
      </div>

      <div class="flex justify-center space-x-4 mt-6">
        <button onclick="closeAdminModal()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">Tutup</button>
        <button onclick="verifyAdmin()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">Login</button>
      </div>
    </div>
  </div>

  <!-- Mini Admin Button -->
  <div class="fixed bottom-2 right-2 bg-gray-800 bg-opacity-60 p-2 rounded-lg shadow-lg">
    <button id="adminToggleBtn" onclick="adminLogin()" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold px-2 py-1 text-xs rounded">
      Admin
    </button>
  </div>

  <!-- Footer -->
  <footer class="text-center mt-12 mb-4 text-sm text-white glow-footer w-full">
    © <span id="fullDate"></span> DEXBLOX.ID — Semua hak cipta dilindungi
  </footer>

  <script>
    // Helper notifikasi
    function showFieldNotif(fieldId,msg,type="error"){
      const el=document.getElementById(fieldId);
      if(el){el.textContent=msg;el.style.color=(type==="success"?"lime":"red");}
    }

    let hargaPer100 = localStorage.getItem("hargaPer100") 
      ? parseInt(localStorage.getItem("hargaPer100")) 
      : 12000;
    document.getElementById("hargaHariIni").textContent = hargaPer100.toLocaleString("id-ID");

    let promoActive=false; let userProfileUrl="";

    function generateGamepassId(robux){return Math.round((robux/100)*143);}
    function updateHargaInfo(robux){
      if(!robux||robux<=0){document.getElementById("paketInfo").textContent="";return;}
      let harga=(robux/100)*hargaPer100;
      if(promoActive){harga=Math.round(harga*0.96);}
      const gamepassId=generateGamepassId(robux);
      document.getElementById("paketInfo").textContent=`${robux} Robux = Rp${harga.toLocaleString("id-ID")} (Gamepass : ${gamepassId})`;
      document.getElementById("robux").value=`${robux} Robux - Rp${harga.toLocaleString("id-ID")} (Gamepass : ${gamepassId})`;
    }

    function togglePaket(el){
      document.getElementById("customRobux").value = "";
      document.querySelectorAll(".paket-card").forEach(card=>{
        card.classList.remove("bg-gray-800"); card.classList.add("bg-gray-700");
      });
      el.classList.remove("bg-gray-700"); el.classList.add("bg-gray-800");
      const robux=parseInt(el.dataset.value);
      updateHargaInfo(robux);
    }

    document.getElementById("customRobux").addEventListener("input",function(){
      const robux=parseInt(this.value);
      updateHargaInfo(robux);
    });

    function checkPromo(){
      const input=document.getElementById("promoInput").value.trim().toUpperCase();
      if(input==="DEX10OFF"){promoActive=true;showFieldNotif("notifPromo","Kode Promo Valid, diskon aktif.","success");}
      else{promoActive=false;showFieldNotif("notifPromo","Kode Promo Salah.","error");}
      const robuxVal=document.getElementById("robux").value.match(/(\d+) Robux/);
      if(robuxVal){updateHargaInfo(parseInt(robuxVal[1]));}
    }

    async function cekUsername(){
      const username=document.getElementById("username").value.trim();
      if(!username){showFieldNotif("notifUsername","Harap isi Username Roblox!","error");return;}
      try{
        const resUser=await fetch("/api/user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username})});
        const dataUser=await resUser.json();
        if(resUser.ok){
          showFieldNotif("notifUsername",`Username ditemukan: ${dataUser.name}`,"success");
          userProfileUrl=dataUser.profileUrl;
          const resAvatar=await fetch(`/api/avatar?userId=${dataUser.userId}`);
          const dataAvatar=await resAvatar.json();
          if(resAvatar.ok && dataAvatar.avatarUrl){
            document.getElementById("avatarPreview").src=dataAvatar.avatarUrl;
            document.getElementById("avatarPreview").classList.remove("hidden");
          }
        }
      }catch(err){showFieldNotif("notifUsername","Gagal cek username","error");}
    }

    document.getElementById("topupForm").addEventListener("submit",function(e){
      e.preventDefault();
      const username=document.getElementById("username").value.trim();
      let robux=document.getElementById("robux").value;
      const hargaText=document.getElementById("paketInfo").textContent;
      const promoCode=document.getElementById("promoInput").value.trim();
      if(!username){showFieldNotif("notifUsername","Harap isi Username Roblox!","error");return;}
      if(document.getElementById("avatarPreview").classList.contains("hidden")){
        showFieldNotif("notifUsername","Harap klik 'Cek Username' dulu!","error");return;}
      if(!robux){showFieldNotif("notifPaket","Harap pilih paket Robux!","error");return;}

      document.getElementById("rUsername").textContent = "Username: " + username;
      document.getElementById("rRobux").textContent = "Paket: " + robux;
      document.getElementById("rHarga").textContent = "Harga: " + hargaText;
      document.getElementById("rPromo").textContent = promoCode ? "Kode Promo: " + promoCode : "";
      document.getElementById("rAvatar").src = document.getElementById("avatarPreview").src;

      const dateNow = new Date();
      const estimate = new Date(Date.now() + 5*24*60*60*1000);
      document.getElementById("rDate").textContent = "Tanggal Transaksi: " + dateNow.toLocaleString("id-ID");
      document.getElementById("rEstimate").textContent = "Estimasi Robux masuk: " + estimate.toLocaleString("id-ID");

      document.getElementById("receiptModal").style.display="flex";

      document.getElementById("sendWA").onclick = function(){
        const gamepassId = robux.match(/Gamepass : (\d+)/)[1];
        const avatarFullUrl = `https://www.roblox.com/avatar-thumbnail/image?username=${encodeURIComponent(username)}&width=420&height=420&format=png`;
        confirmWA(username, robux, "6285362187740", promoCode, gamepassId, avatarFullUrl);
        closeReceipt();
      };
    });

    function closeReceipt(){
      document.getElementById("receiptModal").style.display="none";
    }

    function confirmWA(username, robuxText, adminNumber, promoCode, gamepassId, avatarUrl){
      let message = `Min Dex saya ingin topup gamepass.\n\n` +
                    `Username: ${username}\n` +
                    `Paket: ${robuxText}\n` +
                    `Avatar: ${avatarUrl}\n\n` +
                    `Saya ingin pembayaran via Qris.`;

      if(promoCode){
        message = `Min Dex saya ingin topup gamepass.\n\n` +
                  `Username: ${username}\n` +
                  `Paket: ${robuxText}\n` +
                  `Kode Promo: ${promoCode}\n` +
                  `Avatar: ${avatarUrl}\n\n` +
                  `Saya ingin pembayaran via Qris.`;
      }

      const waLink = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
      window.location.href = waLink;
    }

    // Admin Panel functions
    function adminLogin(){document.getElementById("adminModal").style.display="flex";}
    function closeAdminModal(){document.getElementById("adminModal").style.display="none";}

    function verifyAdmin(){
      const pass=document.getElementById("adminPassword").value;
      if(pass==="dexblox123"){
        document.getElementById("adminToolsHarga").classList.remove("hidden");
        document.getElementById("adminToolsPesanan").classList.remove("hidden");
      } else {
        alert("Password salah!");
      }
    }

    function updateHarga(){
      const baseHarga=parseInt(document.getElementById("baseHarga").value);
      if(isNaN(baseHarga)||baseHarga<=0){alert("Harga tidak valid!");return;}
      hargaPer100=baseHarga;
      localStorage.setItem("hargaPer100",hargaPer100);
      document.getElementById("hargaHariIni").textContent=hargaPer100.toLocaleString("id-ID");
      alert("Harga berhasil diperbarui.");
    }

    // Full layar receipt untuk admin
    function generateReceipt(){
      const username=document.getElementById("username").value;
      const robux=document.getElementById("robux").value;
      const payment="Qris";
      const dateNow=new Date();
      const estimate=new Date(Date.now()+5*24*60*60*1000);
      const avatarFullUrl=`https://www.roblox.com/avatar-thumbnail/image?username=${encodeURIComponent(username)}&width=420&height=420&format=png`;

      document.getElementById("adminModal").style.display="flex";
      document.getElementById("adminContent").style.maxWidth="100%";
      document.getElementById("adminContent").style.width="100%";
      document.getElementById("adminContent").style.height="100%";
      document.getElementById("adminContent").style.borderRadius="0";

      document.getElementById("adminContent").innerHTML = `
        <h2 class="font-bold text-3xl mb-6">Konfirmasi Pesanan (Admin)</h2>
        <div class="admin-avatar mb-6">
          <img src="${avatarFullUrl}" alt="Avatar Roblox Full Body">
        </div>
        <p><strong>Username:</strong> ${username}</p>
        <p><strong>Paket:</strong> ${robux}</p>
        <p><strong>Metode Pembayaran:</strong> ${payment}</p>
        <p><strong>Tanggal Transaksi:</strong> ${dateNow.toLocaleString("id-ID")}</p>
        <p><strong>Estimasi Robux masuk:</strong> ${estimate.toLocaleString("id-ID")}</p>
        <div class="flex justify-center space-x-4 mt-6">
          <button onclick="closeAdminModal()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded">Tutup</button>
        </div>
      `;
    }

    // Background Particles
    const canvas=document.getElementById("particleCanvas");
    const ctx=canvas.getContext("2d");
    canvas.width=window.innerWidth; canvas.height=window.innerHeight;
    let particles=[];
    function createParticle(){
      const x=Math.random()*canvas.width;
      const y=canvas.height+10;
      const size=Math.random()*3+2;
      const speed=Math.random()*1+0.5;
      const dx=(Math.random()-0.5)*0.5;
      const color="rgba(0,255,255,0.7)";
      particles.push({x,y,size,speed,color,dx});
    }
    function drawParticles(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      particles.forEach((p,i)=>{
        ctx.beginPath();
        ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
        ctx.fillStyle=p.color;
        ctx.shadowColor=p.color;
        ctx.shadowBlur=15;
        ctx.fill();
        p.y-=p.speed;
        p.x+=p.dx;
        if(p.y<-10){particles.splice(i,1);}
      });
    }
    function animate(){
      requestAnimationFrame(animate);
      if(particles.length<50){createParticle();}
      drawParticles();
    }
    animate();
    window.addEventListener("resize",()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight;});

    // Footer date
    const today=new Date();
    const options={day:'numeric',month:'long',year:'numeric'};
    document.getElementById("fullDate").textContent=today.toLocaleDateString("id-ID",options);
  </script>

</body>
</html>
