<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DEXBLOX.ID - Topup Robux</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#000; font-family:monospace; }
    .paket-card { transition:all 0.3s ease; border:2px solid transparent; cursor:pointer; }
    .paket-card:hover { transform:scale(1.05); box-shadow:0 0 15px #00f0ff; }
    .btn-anim {transition:all 0.3s ease;}
    .btn-anim:hover {transform:scale(1.05); box-shadow:0 0 15px #00f0ff;}
    .toast {position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:100;
      padding:12px 20px; border-radius:10px; font-weight:bold; background:rgba(255,255,255,0.85); color:#000;}
    .toast-success { border:2px solid #00ff88; }
    .toast-error { border:2px solid #ff0066; }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen relative">

  <!-- Header -->
  <header class="z-10 text-center mt-6 mb-6">
    <h1 class="text-4xl font-bold text-cyan-400">DEXBLOX.ID</h1>
    <p class="text-green-400 mt-2">Topup Robux Termurah & Transparan</p>
  </header>

  <!-- Form Topup -->
  <div class="z-10 w-[90%] max-w-md bg-gray-900 bg-opacity-80 p-6 rounded-xl shadow-lg text-center">
    <h2 class="text-2xl font-bold text-cyan-400 mb-4">Formulir Topup Robux</h2>
    <form id="topupForm" class="space-y-6">
      
      <!-- Username -->
      <div>
        <label class="block mb-1 text-white">Username Roblox</label>
        <input type="text" id="username" class="w-full p-2 rounded bg-gray-700 text-white text-center" placeholder="Masukkan Username Roblox">
        <div class="mt-4 text-center">
          <img id="avatarPreview" class="hidden mx-auto rounded-full border-2 border-cyan-400" width="120" height="120" alt="Avatar Roblox">
        </div>
        <button type="button" onclick="cekUsername()" class="btn-anim bg-yellow-400 hover:bg-yellow-500 text-black font-bold px-4 py-2 rounded mt-2">
          Cek Username
        </button>
      </div>

      <!-- Panel Harga Hari Ini -->
      <section>
        <h3 class="text-lg font-bold text-cyan-400 mb-2">Harga Hari Ini</h3>
        <p class="text-white mb-4">Rp<span id="hargaHariIni">11.000</span> / 100 Robux</p>
        <div id="paketContainerDefault" class="grid grid-cols-2 gap-4">
          <div onclick="selectPaket(this)" class="paket-card p-4 rounded-lg text-white font-bold" data-value="100">100 Robux</div>
          <div onclick="selectPaket(this)" class="paket-card p-4 rounded-lg text-white font-bold" data-value="200">200 Robux</div>
          <div onclick="selectPaket(this)" class="paket-card p-4 rounded-lg text-white font-bold" data-value="500">500 Robux</div>
          <div onclick="selectPaket(this)" class="paket-card p-4 rounded-lg text-white font-bold" data-value="1000">1000 Robux</div>
        </div>
      </section>

      <!-- Custom Paket -->
      <section>
        <h3 class="text-lg font-bold text-cyan-400 mb-2">Custom Paket Robux</h3>
        <div class="flex flex-col items-center space-y-2">
          <input type="number" id="customRobux" class="p-2 rounded bg-gray-700 text-white text-center w-48" placeholder="Jumlah Robux">
        </div>
      </section>

      <!-- Satu baris untuk semua hasil harga -->
      <p id="paketInfo" class="text-green-400 font-bold mt-2"></p>

      <!-- Hidden input -->
      <input type="hidden" id="robux" name="robux">

      <!-- Promo -->
      <div>
        <label class="block mb-1 text-white">Kode Promo</label>
        <div class="flex space-x-2">
          <input type="text" id="promoInput" class="flex-1 p-2 rounded bg-gray-700 text-white text-center" placeholder="Masukkan kode promo">
          <button type="button" onclick="checkPromo()" class="btn-anim bg-yellow-400 hover:bg-yellow-500 text-black font-bold px-4 rounded">Cek</button>
        </div>
      </div>

      <!-- Submit -->
      <button type="submit" class="btn-anim w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded shadow-lg">
        Topup via WhatsApp
      </button>
    </form>
  </div>

  <!-- Admin Panel -->
  <div class="z-10 mt-6 mb-6 text-center bg-gray-800 bg-opacity-20 p-4 rounded-lg max-w-md mx-auto">
    <button onclick="adminLogin()" class="btn-anim bg-white bg-opacity-20 text-transparent font-bold px-6 py-2 rounded">Admin Login</button>
    <div id="adminPanel" style="display:none;" class="mt-4 space-y-2">
      <input type="number" id="baseHarga" value="11000" class="p-2 rounded bg-gray-700 text-white text-center w-48" placeholder="Harga per 100 Robux">
      <button onclick="updateHarga()" class="btn-anim bg-red-500 hover:bg-red-600 text-white font-bold px-4 py-2 rounded">Update Harga</button>
    </div>
  </div>

  <!-- Modal Admin -->
  <div id="adminModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="bg-gray-900 p-6 rounded-lg shadow-lg text-center max-w-sm border border-green-400">
      <h2 class="text-green-400 font-bold text-lg mb-4">Admin Login</h2>
      <input type="password" id="adminPassword" class="w-full p-2 rounded bg-gray-800 text-white text-center mb-4" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      <div class="flex justify-center space-x-4">
        <button onclick="closeAdminModal()" class="btn-anim bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">Batal</button>
        <button onclick="verifyAdmin()" class="btn-anim bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">Oke</button>
      </div>
    </div>
  </div>

  <!-- Script -->
  <script>
    function showToast(msg,type="error"){
      const toast=document.createElement("div");
      toast.className=`toast ${type==="success"?"toast-success":"toast-error"}`;
      toast.innerHTML=msg;
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(),3000);
    }

    let hargaPer100=parseInt(localStorage.getItem("hargaPer100"))||11000;
    document.getElementById("hargaHariIni").textContent=hargaPer100.toLocaleString("id-ID");

    let promoActive=false;
    let userProfileUrl="";

    function selectPaket(el){
      document.querySelectorAll(".paket-card").forEach(card=>card.classList.remove("ring-2","ring-cyan-400","bg-cyan-900"));
      el.classList.add("ring-2","ring-cyan-400","bg-cyan-900");
      const robux=parseInt(el.dataset.value);
      const harga=(robux/100)*hargaPer100;
      const gamepassId=Math.round((robux/100)*143);
      document.getElementById("robux").value=`${robux} Robux - Rp${harga.toLocaleString("id-ID")} (ID:${gamepassId})`;
      document.getElementById("paketInfo").textContent=`${robux} Robux = Rp${harga.toLocaleString("id-ID")} (Gamepass ID: ${gamepassId})`;
    }

    // Custom Paket
    document.getElementById("customRobux").addEventListener("input", function(){
      const robux=parseInt(this.value);
      const info=document.getElementById("paketInfo"); // satu baris untuk semua

      if(!robux || robux<=0){
        info.textContent="";
        return;
      }

      const harga=(robux/100)*hargaPer100;
      const gamepassId=Math.round((robux/100)*143);

      info.textContent=`${robux} Robux = Rp${harga.toLocaleString("id-ID")} (Gamepass ID: ${gamepassId})`;
      document.getElementById("robux").value=`${robux} Robux - Rp${harga.toLocaleString("id-ID")} (ID:${gamepassId})`;
    });

    // Promo
    function checkPromo(){
      const input=document.getElementById("promoInput").value.trim().toUpperCase();
      if(input==="DEX10OFF"){
        promoActive=true;
        showToast("âœ… Kode Promo Valid! Diskon 4% aktif.","success");
      }else{
        promoActive=false;
        showToast("âŒ Kode Promo Salah.","error");
      }
    }

    // Cek Username + Avatar
    async function cekUsername(){
      const username=document.getElementById("username").value.trim();
      if(!username){showToast("âš ï¸ Harap isi Username Roblox!","error");return;}
      try{
        const resUser=await fetch("/api/user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username})});
        const dataUser=await resUser.json();
        if(resUser.ok){
          showToast(`âœ… Username ditemukan: ${dataUser.name}`,"success");
          userProfileUrl=dataUser.profileUrl;
          const resAvatar=await fetch(`/api/avatar?userId=${dataUser.userId}`);
          const dataAvatar=await resAvatar.json();
          if(resAvatar.ok){
            document.getElementById("avatarPreview").src=dataAvatar.avatarUrl;
            document.getElementById("avatarPreview").classList.remove("hidden");
          }
        }else{
          showToast("âŒ "+dataUser.error,"error");
        }
      }catch(err){
        showToast("âš ï¸ Gagal cek username","error");
      }
    }

    // WhatsApp Redirect
    document.getElementById("topupForm").addEventListener("submit",function(e){
      e.preventDefault();
      const username=document.getElementById("username").value.trim();
      let robux=document.getElementById("robux").value;
      const adminNumber="6285362187740";

      if(!username){showToast("âš ï¸ Harap isi Username Roblox!","error");return;}
      if(!robux){showToast("âš ï¸ Harap pilih paket Robux!","error");return;}

      // Promo diskon
      if(promoActive){
        const match=robux.match(/Rp([\d\.]+)/);
        if(match){
          const basePrice=parseInt(match[1].replace(/\./g,""));
          const discounted=Math.round(basePrice*0.96);
          robux=robux.replace(/Rp[\d\.]+/,"Rp"+discounted.toLocaleString("id-ID"));
        }
      }

      const message=`Halo Admin DEXBLOX.ID %0AUsername: ${username}%0APaket: ${robux}%0AProfile: ${userProfileUrl}`;
      const waLink=`https://wa.me/${adminNumber}?text=${message}`;
      showToast("âœ… Data lengkap, kirim ke WhatsApp","success");
      setTimeout(()=>{window.open(waLink,"_blank");},2000);
    });

    // Admin Login
    function adminLogin(){document.getElementById("adminModal").classList.remove("hidden");}
    function closeAdminModal(){document.getElementById("adminModal").classList.add("hidden");}
    function verifyAdmin(){
      const pass=document.getElementById("adminPassword").value;
      if(pass==="dexblox123"){
        document.getElementById("adminPanel").style.display="block";
        showToast("ðŸ”“ ACCESS GRANTED â€“ Welcome Admin","success");
        closeAdminModal();
      }else{
        showToast("â›” ACCESS DENIED â€“ Wrong Password","error");
      }
    }
    function updateHarga(){
      const baseHarga=parseInt(document.getElementById("baseHarga").value);
      if(isNaN(baseHarga)||baseHarga<=0){showToast("âš ï¸ Harga tidak valid!","error");return;}
      hargaPer100=baseHarga;
      localStorage.setItem("hargaPer100",hargaPer100);
      document.getElementById("hargaHariIni").textContent=hargaPer100.toLocaleString("id-ID");
      showToast(`âœ… Harga diperbarui: Rp${hargaPer100.toLocaleString("id-ID")} per 100 Robux`,"success");
    }
  </script>
</body>
</html>
