<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <!-- Non-zoomable viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DEXBLOX - Topup Robux</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: #ffffff;
      font-family: Arial, sans-serif;
      color: #000000;
    }
    h1, h2, h3, p, label { color: #000; text-shadow: none; }
    .paket-card {
      transition:.3s;cursor:pointer;background:rgba(0,0,0,0.05);color:#000;
    }
    .paket-card:hover {transform:scale(1.03);background:rgba(0,0,0,0.1);}
    #notifPanel {
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:50
    }
    #notifContent {
      background:rgba(255,255,255,0.9);
      border:2px solid #000;
      box-shadow:0 0 20px #aaa;
      padding:20px;border-radius:12px;text-align:center;max-width:320px;color:#000;
    }
    .panel-buttons button.active { background:#000;color:#fff; }
    .panel-box { background:rgba(255,255,255,0.9); }
    footer {color:#000;}
  </style>
</head>
<body class="flex flex-col items-center min-h-screen relative">

<header class="z-10 text-center mt-6 mb-6">
  <h1 class="text-5xl font-extrabold">DEXBLOX</h1>
  <div class="rating mt-2">Topup Robux Termurah Di Indonesia</div>
</header>

<!-- Panel Buttons -->
<div class="panel-buttons flex justify-center space-x-4 mt-4 z-10">
  <button id="btn5hari" class="active px-4 py-2 rounded">Robux 5 Hari</button>
  <button id="btnLangsung" class="px-4 py-2 rounded">Via Login</button>
  <button id="btnKomunitas" class="px-4 py-2 rounded">Via Komunitas</button>
</div>

<!-- Panel Content -->
<div id="panel5hari" class="panel-box mt-6 z-10 w-[90%] max-w-md p-6 rounded-xl shadow-lg text-center">
  <h2 class="text-2xl font-bold mb-4">Robux 5 hari</h2>
  <form id="topupForm" class="space-y-6">
    <!-- Username -->
    <div>
      <label class="block mb-1">Username Roblox</label>
      <input type="text" id="username" class="w-full p-2 rounded border text-center" placeholder="Masukkan Username Roblox">
      <p id="notifUsername" class="text-xs mt-1"></p>
      <div class="mt-4 text-center">
        <img id="avatarPreview" class="hidden mx-auto rounded-full border" width="120" height="120" alt="Avatar Roblox">
      </div>
      <button type="button" id="btnCekUser" class="bg-black text-white font-bold px-4 py-2 rounded mt-2">Cek Username</button>
    </div>

    <!-- WA -->
    <div>
      <label class="block mb-1">Nomor WhatsApp</label>
      <input type="text" id="userWA" class="w-full p-2 rounded border text-center" placeholder="62xxxxxxxxxx">
      <p id="notifWA" class="text-xs mt-1"></p>
    </div>

    <!-- Paket -->
    <section>
      <h3 class="text-lg font-bold mb-2">Harga Hari Ini</h3>
      <p class="mb-4">
        Rp <span id="hargaHariIni" data-harga="13000" class="text-2xl font-extrabold">13.000</span> / 100 Robux
      </p>
      <div class="grid grid-cols-2 gap-4">
        <div class="paket-card p-4 rounded-lg font-bold" data-value="100">100 Robux</div>
        <div class="paket-card p-4 rounded-lg font-bold" data-value="200">200 Robux</div>
        <div class="paket-card p-4 rounded-lg font-bold" data-value="500">500 Robux</div>
        <div class="paket-card p-4 rounded-lg font-bold" data-value="1000">1000 Robux</div>
      </div>
      <p id="notifPaket" class="text-xs mt-1"></p>
    </section>

    <!-- Custom Paket -->
    <section>
      <h3 class="text-lg font-bold mb-2">Custom Paket Robux</h3>
      <input type="number" id="customRobux" class="p-2 rounded border text-center w-48" placeholder="Jumlah Robux">
      <p id="notifCustom" class="text-xs mt-1"></p>
    </section>

    <p id="paketInfo" class="font-bold mt-2"></p>
    <input type="hidden" id="robux" name="robux">

    <!-- Promo -->
    <div>
      <label class="block mb-1">Kode Promo</label>
      <div class="flex space-x-2">
        <input type="text" id="promoInput" class="flex-1 p-2 rounded border text-center" placeholder="Masukkan kode promo">
        <button type="button" id="btnPromo" class="bg-black text-white font-bold px-4 rounded">Cek</button>
      </div>
      <p id="notifPromo" class="text-xs mt-1"></p>
    </div>

    <button type="submit" class="w-full bg-black text-white font-bold py-2 px-4 rounded shadow-lg">Topup</button>
  </form>
</div>

<div id="panelLogin" class="hidden panel-box mt-6 z-10 w-[90%] max-w-md p-6 rounded-xl shadow-lg text-center">
  <h2 class="text-2xl font-bold mb-4">Via Login</h2>
  <p>COMING SOON</p>
</div>

<div id="panelKomunitas" class="hidden panel-box mt-6 z-10 w-[90%] max-w-md p-6 rounded-xl shadow-lg text-center">
  <h2 class="text-2xl font-bold mb-4">Via Komunitas</h2>
  <p>COMING SOON</p>
</div>

<!-- Admin Panel -->
<div id="adminModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
  <div class="panel-box p-6 rounded-lg shadow-lg text-center max-w-sm border border-black">
    <h2 class="font-bold text-lg mb-4">Admin Panel</h2>
    <input type="password" id="adminPassword" class="w-full p-2 rounded border text-center mb-4" placeholder="••••••••">
    <div id="adminTools" class="hidden">
      <label class="block mb-2">Update Harga per 100 Robux</label>
      <input type="number" id="baseHarga" class="w-full p-2 rounded border text-center mb-4" placeholder="Masukkan harga baru">
      <button id="btnUpdateHarga" class="bg-black text-white px-4 py-2 rounded">Simpan Harga</button>
      <button id="btnLogoutAdmin" class="bg-gray-500 text-white px-4 py-2 rounded mt-2">Logout</button>

      <h3 class="font-bold mt-6 mb-2">Kirim Bukti ke User</h3>
      <input type="text" id="adminUser" placeholder="Username Roblox" class="w-full p-2 rounded border mb-2">
      <button id="btnAdminCekUser" class="bg-black text-white font-bold px-4 py-2 rounded mb-2">Cek Username</button>
      <img id="adminAvatar" class="hidden mx-auto mb-2 rounded-full border" width="100" height="100" alt="Avatar Roblox">
      <p id="adminNotifUser" class="text-xs mb-2"></p>

      <input type="text" id="adminRobux" placeholder="Jumlah Robux" class="w-full p-2 rounded border mb-2">
      <select id="adminMetode" class="w-full p-2 rounded border mb-2">
        <option value="">-- Pilih Metode Pembayaran --</option>
        <option value="DANA">DANA</option>
        <option value="GoPay">GoPay</option>
        <option value="QRIS">QRIS</option>
        <option value="OVO">OVO</option>
        <option value="ShopeePay">ShopeePay</option>
      </select>

      <input type="text" id="adminWA" placeholder="Nomor WhatsApp User (62...)" class="w-full p-2 rounded border mb-2">
      <button id="btnKirimBukti" class="bg-black text-white px-4 py-2 rounded">Kirim Bukti</button>
    </div>
    <div class="flex justify-center space-x-4 mt-4">
      <button id="btnCloseAdmin" class="bg-red-500 text-white px-4 py-2 rounded">Tutup</button>
      <button id="btnLoginAdmin" class="bg-green-500 text-white px-4 py-2 rounded">Login</button>
    </div>
  </div>
</div>

<!-- Mini Admin Button -->
<div class="fixed bottom-2 right-2 bg-gray-200 p-1 rounded-lg shadow-lg">
  <button id="adminToggleBtn" class="relative bg-black text-white px-2 py-1 rounded-full transition duration-300 ease-in-out shadow-lg">⚙️</button>
</div>

<!-- Notifikasi Konfirmasi -->
<div id="notifPanel">
  <div id="notifContent"></div>
</div>

<!-- Footer -->
<footer class="text-center mt-12 mb-4 text-sm w-full">
  © <span id="fullDate"></span> DEXBLOX All Rights Reserved
</footer>

<script>
// Panel toggle
function showPanel(panelId){
  document.getElementById("panel5hari").classList.add("hidden");
  document.getElementById("panelLogin").classList.add("hidden");
  document.getElementById("panelKomunitas").classList.add("hidden");
  document.getElementById(panelId).classList.remove("hidden");
  document.querySelectorAll(".panel-buttons button").forEach(btn=>btn.classList.remove("active"));
  document.querySelector(`#${panelId.replace("panel","btn")}`).classList.add("active");
}
document.getElementById("btn5hari").addEventListener("click",()=>showPanel("panel5hari"));
document.getElementById("btnLangsung").addEventListener("click",()=>showPanel("panelLogin"));
document.getElementById("btnKomunitas").addEventListener("click",()=>showPanel("panelKomunitas"));

// Fungsi notifikasi field
function showFieldNotif(fieldId,msg,type="error"){
  const el=document.getElementById(fieldId);
  if(el){el.textContent=msg;el.style.color=(type==="success"?"green":"red");}
}

// Harga default
let hargaPer100 = parseInt(document.getElementById("hargaHariIni").dataset.harga);
document.getElementById("hargaHariIni").textContent = hargaPer100.toLocaleString("id-ID");
let promoActive=false; let userProfileUrl="";

function updateHargaInfo(robux){
  if(!robux||robux<=0){document.getElementById("paketInfo").textContent="";return;}
  let harga=(robux/100)*hargaPer100;
  if(promoActive){harga=Math.round(harga*0.96);}
  const gamepassId=Math.round((robux/100)*143);
  document.getElementById("paketInfo").textContent=`${robux} Robux = Rp${harga.toLocaleString("id-ID")} (Gamepass : ${gamepassId})`;
  document.getElementById("robux").value=`${robux} Robux - Rp${harga.toLocaleString("id-ID")} (Gamepass : ${gamepassId})`;
}

// Paket toggle
document.querySelectorAll(".paket-card").forEach(card=>{
  card.addEventListener("click",()=>{
    document.getElementById("customRobux").value="";
    document.querySelectorAll(".paket-card").forEach(c=>c.classList.remove("bg-gray-300"));
    card.classList.add("bg-gray-300");
    updateHargaInfo(parseInt(card.dataset.value));
  });
});

// Custom paket
document.getElementById("customRobux").addEventListener("input",function(){
  updateHargaInfo(parseInt(this.value));
});

// Promo
document.getElementById("btnPromo").addEventListener("click",()=>{
  const input=document.getElementById("promoInput").value.trim().toUpperCase();
  if(input==="DEX10OFF"){promoActive=true;showFieldNotif("notifPromo","Kode Promo Valid, diskon aktif.","success");}
  else{promoActive=false;showFieldNotif("notifPromo","Kode Promo Salah.","error");}
  const robuxVal=document.getElementById("robux").value.match(/(\d+) Robux/);
  if(robuxVal){updateHargaInfo(parseInt(robuxVal[1]));}
});

// Cek Username
document.getElementById("btnCekUser").addEventListener("click",cekUsername);
async function cekUsername(){
  const username=document.getElementById("username").value.trim();
  if(!username){showFieldNotif("notifUsername","Harap isi Username Roblox!","error");return;}
  try{
    const resUser=await fetch("/api/user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username})});
    const dataUser=await resUser.json();
    if(resUser.ok){
      showFieldNotif("notifUsername",`Username ditemukan: ${dataUser.name}`,"success");
      userProfileUrl=dataUser.profileUrl;
      const resAvatar=await fetch(`/api/avatar?userId=${dataUser.userId}`);
      const dataAvatar=await resAvatar.json();
      if(resAvatar.ok && dataAvatar.avatarUrl){
        document.getElementById("avatarPreview").src=dataAvatar.avatarUrl;
        document.getElementById("avatarPreview").classList.remove("hidden");
      }
    }else{showFieldNotif("notifUsername","Error: "+dataUser.error,"error");}
  }catch(err){showFieldNotif("notifUsername","Gagal cek username","error");}
}

// Submit form
document.getElementById("topupForm").addEventListener("submit",function(e){
  e.preventDefault();
  const username=document.getElementById("username").value.trim();
  let robux=document.getElementById("robux").value;
  const adminNumber="6285362187740";
  const userWA=document.getElementById("userWA").value.trim();
  if(!username){showFieldNotif("notifUsername","Harap isi Username Roblox!","error");return;}
  if(document.getElementById("avatarPreview").classList.contains("hidden")){
    showFieldNotif("notifUsername","Harap klik 'Cek Username' dulu!","error");return;}
  if(!robux){showFieldNotif("notifPaket","Harap pilih paket Robux!","error");return;}
  if(!userWA){showFieldNotif("notifWA","Harap isi nomor WhatsApp user!","error");return;}

  const panel=document.getElementById("notifPanel");
  const content=document.getElementById("notifContent");
  panel.style.display="flex";
  const hargaText=document.getElementById("paketInfo").textContent;
  const promoCode=document.getElementById("promoInput").value.trim();
  const avatarSrc=document.getElementById("avatarPreview").src;
  const now = new Date().toLocaleString("id-ID");
  content.innerHTML=`
    <h3 class="font-bold mb-4">Konfirmasi Topup</h3>
    <img src="${avatarSrc}" alt="Avatar Roblox" class="mx-auto mb-4 rounded-full border" width="120" height="120">
    <p class="mb-4">
      Username: <span class="font-bold">${username}</span><br>
      Paket: <span class="font-bold">${robux}</span><br>
      Nomor WA User: <span class="font-bold">${userWA}</span><br>
      Profile: <a href="${userProfileUrl}" target="_blank" class="underline">Lihat Profil</a><br>
      Waktu: ${now}
      ${promoCode ? `<br>Kode Promo: <span class="font-bold">${promoCode}</span>` : ""}
    </p>
    <div class="flex justify-center space-x-4">
      <button id="btnConfirmWA" class="bg-green-500 text-white px-4 py-2 rounded">Ya</button>
      <button id="btnCancelWA" class="bg-red-500 text-white px-4 py-2 rounded">Tidak</button>
    </div>`;
   document.getElementById("btnConfirmWA").addEventListener("click",()=>confirmWA(username,robux,adminNumber,promoCode,hargaText,avatarSrc,userWA));
  document.getElementById("btnCancelWA").addEventListener("click",cancelWA);
});

function confirmWA(username,robux,adminNumber,promoCode,hargaText,avatarSrc,userWA){
  const now = new Date().toLocaleString("id-ID");
  let message=` Halo Min Dex saya ingin topup
 Username: ${username}
 Paket: ${robux}
 Profile: ${userProfileUrl}
 WA User: ${userWA}
 Waktu: ${now}${promoCode ? `\n Promo: ${promoCode}` : ""}

Mohon diproses Admin.`;
  const waLink=`https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
  window.open(waLink,"_blank");
  cancelWA();
}
function cancelWA(){document.getElementById("notifPanel").style.display="none";}

// Background Particles
const canvas = document.createElement("canvas");
canvas.id="particleCanvas";
document.body.appendChild(canvas);
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let bubbles = [];
function createBubble(){
  const x=Math.random()*canvas.width;
  const y=canvas.height+20;
  const size=Math.random()*6+2;
  const speed=Math.random()*1+0.5;
  const dx=(Math.random()-0.5)*0.3;
  const color="rgba(0,0,0,0.2)";
  bubbles.push({x,y,size,speed,color,dx});
}
function drawBubbles(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  bubbles.forEach((b,i)=>{
    ctx.beginPath();
    ctx.arc(b.x,b.y,b.size,0,Math.PI*2);
    ctx.strokeStyle=b.color;
    ctx.lineWidth=1.5;
    ctx.stroke();
    b.y-=b.speed;
    b.x+=b.dx;
    if(b.y<-20){bubbles.splice(i,1);}
  });
}
function animate(){requestAnimationFrame(animate);if(bubbles.length<60){createBubble();}drawBubbles();}
animate();
window.addEventListener("resize",()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight;});

// Admin Panel binding
document.getElementById("adminToggleBtn").addEventListener("click",()=>{document.getElementById("adminModal").classList.remove("hidden");});
document.getElementById("btnCloseAdmin").addEventListener("click",()=>{document.getElementById("adminModal").classList.add("hidden");});
document.getElementById("btnLoginAdmin").addEventListener("click",verifyAdmin);
document.getElementById("btnLogoutAdmin").addEventListener("click",logoutAdmin);
document.getElementById("btnUpdateHarga").addEventListener("click",updateHarga);
document.getElementById("btnAdminCekUser").addEventListener("click",cekUserAdmin);
document.getElementById("btnKirimBukti").addEventListener("click",kirimBuktiAdmin);

function verifyAdmin(){
  const pass=document.getElementById("adminPassword").value;
  if(pass==="54321"){
    document.getElementById("adminTools").classList.remove("hidden");
    document.getElementById("adminToggleBtn").textContent="Admin (ON)";
  } else { alert("Password salah!"); }
}
function logoutAdmin(){
  document.getElementById("adminTools").classList.add("hidden");
  document.getElementById("adminToggleBtn").textContent="Admin";
}
function updateHarga(){
  const baseHarga=parseInt(document.getElementById("baseHarga").value);
  if(isNaN(baseHarga)||baseHarga<=0){alert("Harga tidak valid!");return;}
  hargaPer100=baseHarga;
  document.getElementById("hargaHariIni").dataset.harga=hargaPer100;
  document.getElementById("hargaHariIni").textContent=hargaPer100.toLocaleString("id-ID");
  alert("Harga berhasil diperbarui!");
}

// Admin cek user
async function cekUserAdmin(){
  const username=document.getElementById("adminUser").value.trim();
  if(!username){document.getElementById("adminNotifUser").textContent="Harap isi Username!";return;}
  try{
    const resUser=await fetch("/api/user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username})});
    const dataUser=await resUser.json();
    if(resUser.ok){
      document.getElementById("adminNotifUser").textContent=`Username ditemukan: ${dataUser.name}`;
      const resAvatar=await fetch(`/api/avatar?userId=${dataUser.userId}`);
      const dataAvatar=await resAvatar.json();
      if(resAvatar.ok && dataAvatar.avatarUrl){
        document.getElementById("adminAvatar").src=dataAvatar.avatarUrl;
        document.getElementById("adminAvatar").classList.remove("hidden");
      }
    } else {
      document.getElementById("adminNotifUser").textContent="Error: "+dataUser.error;
    }
  }catch(err){
    document.getElementById("adminNotifUser").textContent="Gagal cek username";
  }
}

// Format tanggal
function formatDate(dateObj) {
  return dateObj.toLocaleString("id-ID", {
    day: "numeric",month: "long",year: "numeric",hour: "2-digit",minute: "2-digit"
  });
}

// Kirim bukti admin
function kirimBuktiAdmin(){
  const username=document.getElementById("adminUser").value.trim();
  const robux=document.getElementById("adminRobux").value.trim();
  const metode=document.getElementById("adminMetode").value.trim();
  const userWA=document.getElementById("adminWA").value.trim();
  if(!username||!robux||!metode||!userWA){alert("Lengkapi semua data!");return;}
  const now=new Date();const future=new Date();future.setDate(now.getDate()+5);
  const message=` Bukti Pembayaran DEXBLOX

 Username: ${username}
 Paket: ${robux} Robux
 Metode: ${metode}
 Waktu Transaksi: ${formatDate(now)}
 Estimasi Selesai: ${formatDate(future)}
 Profil: ${userProfileUrl}

Robux akan masuk sesuai estimasi.
Terima kasih sudah topup di DEXBLOX.ID `;
  const waLink=`https://wa.me/${userWA}?text=${encodeURIComponent(message)}`;
  if(confirm("Kirim bukti ke user via WhatsApp?")){
    window.open(waLink,"_blank");
  }
}

// Footer date
const today = new Date();
const options = { day: 'numeric', month: 'long', year: 'numeric' };
document.getElementById("fullDate").textContent = today.toLocaleDateString("id-ID", options);
</script>

</body>
  </html>
